name: Price Refresh

on:
  schedule:
    # Run every hour at the top of the hour
    - cron: "0 * * * *"
  workflow_dispatch: # Allow manual triggering

jobs:
  refresh-prices:
    runs-on: ubuntu-latest
    
    steps:
    - name: Trigger Price Refresh
      run: |
        echo "Triggering scheduled price refresh for $REFRESH_ENDPOINT_URL"
        curl -X POST "$REFRESH_ENDPOINT_URL" \
          -H "Content-Type: application/json" \
          -H "X-Refresh-Mode: auto" \
          ${REFRESH_AUTH_HEADER:+ -H "$REFRESH_AUTH_HEADER"} \
          --fail --show-error --max-time 30
      env:
        REFRESH_ENDPOINT_URL: ${{ secrets.REFRESH_ENDPOINT_URL }}
        REFRESH_AUTH_HEADER: ${{ secrets.REFRESH_AUTH_HEADER }}

    - name: Log Success
      if: success()
      run: |
        echo "✅ Price refresh completed successfully"
        echo "Endpoint: $REFRESH_ENDPOINT_URL"
        echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"

    - name: Log Failure
      if: failure()
      run: |
        echo "❌ Price refresh failed"
        echo "Endpoint: $REFRESH_ENDPOINT_URL"
        echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        echo "Check the application logs for detailed error information."
        exit 1