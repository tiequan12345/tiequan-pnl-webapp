generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Asset {
  id                Int      @id @default(autoincrement())
  symbol            String
  name              String
  type              String
  volatility_bucket String
  chain_or_market   String
  pricing_mode      String
  manual_price      Decimal?
  metadata_json     String?
  status            String   @default("ACTIVE")
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  ledger_transactions LedgerTransaction[]
  price_latest        PriceLatest?

  @@index([symbol])
}

model Account {
  id              Int      @id @default(autoincrement())
  name            String
  platform        String
  account_type    String
  chain_or_market String?
  status          String
  notes           String?
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  ledger_transactions      LedgerTransaction[]
  tradestation_connection TradeStationConnection?
  ccxt_connection         CcxtConnection?
  ccxt_sync_jobs          CcxtSyncJob[]

  @@index([name])
}

model TradeStationConnection {
  id                   Int      @id @default(autoincrement())
  account_id            Int      @unique
  ts_account_id         String?
  access_token          String?
  refresh_token         String
  token_expires_at      DateTime?
  scopes                String?
  status                String   @default("ACTIVE")
  last_sync_at          DateTime?
  last_order_sync_at    DateTime?
  last_order_next_token String?
  metadata_json         String?
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([ts_account_id])
}

model CcxtConnection {
  id                Int      @id @default(autoincrement())
  account_id        Int      @unique
  exchange_id       String

  api_key_enc       String
  api_secret_enc    String
  passphrase_enc    String?

  options_json      String?
  sandbox           Boolean  @default(false)

  status            String   @default("ACTIVE")
  last_sync_at      DateTime?
  last_trade_sync_at DateTime?
  last_trade_cursor String?
  sync_since        DateTime?

  metadata_json     String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([exchange_id])
  @@index([status])
}

model CcxtSyncJob {
  id           Int      @id @default(autoincrement())
  account_id   Int
  exchange_id  String
  mode         String
  since        DateTime?
  requested_by String   @default("MANUAL")
  status       String   @default("QUEUED")
  attempts     Int      @default(0)
  claim_token  String?
  result_json  String?
  error_message String?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  started_at   DateTime?
  finished_at  DateTime?

  account Account @relation(fields: [account_id], references: [id], onDelete: Cascade)

  @@index([status, created_at])
  @@index([account_id, exchange_id, status])
  @@index([created_at])
}

model LedgerTransaction {
  id                  Int      @id @default(autoincrement())
  date_time           DateTime
  account_id          Int
  asset_id            Int
  quantity            Decimal
  tx_type             String
  external_reference  String?
  notes               String?
  unit_price_in_base  Decimal?
  total_value_in_base Decimal?
  fee_in_base         Decimal?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  account Account @relation(fields: [account_id], references: [id])
  asset   Asset   @relation(fields: [asset_id], references: [id])

  @@index([date_time])
  @@index([account_id])
  @@index([asset_id])
  @@index([tx_type])
  @@index([account_id, external_reference])
}

model PriceLatest {
  id            Int      @id @default(autoincrement())
  asset_id      Int      @unique
  price_in_base Decimal
  source        String
  last_updated  DateTime

  asset Asset @relation(fields: [asset_id], references: [id])
}

model Setting {
  key   String @id
  value String
}

model PriceRefreshRun {
  id         Int       @id @default(autoincrement())
  started_at DateTime  @default(now())
  ended_at   DateTime?
  status     String // 'RUNNING', 'SUCCESS', 'FAILED', 'PARTIAL'
  mode       String // 'MANUAL', 'SCHEDULED'
  metadata   String? // JSON string for stats

  @@index([started_at])
  @@index([status])
}

model PortfolioSnapshot {
  id            Int      @id @default(autoincrement())
  snapshot_at   DateTime
  base_currency String   @default("USD")
  total_value   Decimal
  created_at    DateTime @default(now())

  components PortfolioSnapshotComponent[]

  @@unique([snapshot_at])
  @@index([snapshot_at])
}

model PortfolioSnapshotComponent {
  id                Int      @id @default(autoincrement())
  snapshot_id       Int
  asset_id          Int
  asset_symbol      String
  asset_name        String
  asset_type        String
  volatility_bucket String
  account_id        Int
  account_name      String
  quantity          Decimal
  price_in_base     Decimal?
  market_value      Decimal?

  snapshot PortfolioSnapshot @relation(fields: [snapshot_id], references: [id], onDelete: Cascade)

  @@index([snapshot_id])
  @@index([snapshot_id, asset_type])
  @@index([snapshot_id, volatility_bucket])
  @@index([snapshot_id, account_id])
}
