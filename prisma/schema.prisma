generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Asset {
  id                Int               @id @default(autoincrement())
  symbol            String
  name              String
  type              String
  volatility_bucket String
  chain_or_market   String
  pricing_mode      String
  manual_price      Decimal?
  metadata_json     String?
  created_at        DateTime          @default(now())
  updated_at        DateTime          @updatedAt

  ledger_transactions LedgerTransaction[]
  price_latest        PriceLatest?

  @@index([symbol])
}

model Account {
  id              Int                 @id @default(autoincrement())
  name            String
  platform        String
  account_type    String
  chain_or_market String?
  status          String
  notes           String?
  created_at      DateTime            @default(now())
  updated_at      DateTime            @updatedAt

  ledger_transactions LedgerTransaction[]

  @@index([name])
}

model LedgerTransaction {
  id                 Int      @id @default(autoincrement())
  date_time          DateTime
  account_id         Int
  asset_id           Int
  quantity           Decimal
  tx_type            String
  external_reference String?
  notes              String?
  unit_price_in_base Decimal?
  total_value_in_base Decimal?
  fee_in_base        Decimal?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt

  account Account @relation(fields: [account_id], references: [id])
  asset   Asset   @relation(fields: [asset_id], references: [id])

  @@index([date_time])
  @@index([account_id])
  @@index([asset_id])
  @@index([tx_type])
}

model PriceLatest {
  id            Int      @id @default(autoincrement())
  asset_id      Int      @unique
  price_in_base Decimal
  source        String
  last_updated  DateTime

  asset Asset @relation(fields: [asset_id], references: [id])
}

model Setting {
  key   String @id
  value String
}

model PriceRefreshRun {
  id         Int      @id @default(autoincrement())
  started_at DateTime @default(now())
  ended_at   DateTime?
  status     String   // 'RUNNING', 'SUCCESS', 'FAILED', 'PARTIAL'
  mode       String   // 'MANUAL', 'SCHEDULED'
  metadata   String?  // JSON string for stats

  @@index([started_at])
  @@index([status])
}

model PortfolioSnapshot {
  id            Int      @id @default(autoincrement())
  snapshot_at   DateTime
  base_currency String   @default("USD")
  total_value   Decimal
  created_at    DateTime @default(now())

  components PortfolioSnapshotComponent[]

  @@index([snapshot_at])
  @@unique([snapshot_at])
}

model PortfolioSnapshotComponent {
  id               Int      @id @default(autoincrement())
  snapshot_id      Int
  asset_id         Int
  asset_symbol     String
  asset_name       String
  asset_type       String
  volatility_bucket String
  account_id       Int
  account_name     String
  quantity         Decimal
  price_in_base    Decimal?
  market_value     Decimal?

  snapshot PortfolioSnapshot @relation(fields: [snapshot_id], references: [id], onDelete: Cascade)

  @@index([snapshot_id])
  @@index([snapshot_id, asset_type])
  @@index([snapshot_id, volatility_bucket])
  @@index([snapshot_id, account_id])
}